---
import "../styles/global.css";
import SiteFooter from "../components/SiteFooter.astro";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Fetch OpenPGP public keys for leter.net users via Web Key Discovery. Look up any user's key for end-to-end encrypted communication."
    />
    <meta name="theme-color" content="#050505" />
    <title>Web Key Discovery — leter.net</title>
  </head>

  <body>
    <!-- ─── Shared nav (matches Hero.astro) ─────────────────────────────── -->
    <section class="relative overflow-hidden border-b border-white/10">
      <header class="container-width relative py-6">
        <div
          class="flex items-center justify-center rounded-xl border border-white/15 bg-black/45 px-4 py-3 backdrop-blur-sm md:justify-between"
        >
          <div class="flex items-center gap-2">
            <a href="/" class="text-sm font-semibold tracking-tight text-text">leter.net</a>
            <span class="text-xs text-muted">by</span>
            <a
              href="https://lewsion.com"
              target="_blank"
              rel="noreferrer"
              class="text-xs font-medium text-text underline decoration-white/40 underline-offset-2 hover:decoration-white/70"
            >
              lewsion.com
            </a>
          </div>

          <nav class="hidden items-center gap-6 text-sm text-muted md:flex">
            <a class="transition-colors hover:text-text" href="/#current-state">Current state</a>
            <a class="transition-colors hover:text-text" href="/#security">Security</a>
            <a class="transition-colors hover:text-text" href="/#initiative">Scope</a>
            <a class="transition-colors hover:text-text" href="/#principles">Principles</a>
            <a class="transition-colors hover:text-text" href="/#roadmap">Direction</a>
            <a class="text-green transition-colors" href="/wkd">WKD</a>
          </nav>
        </div>
      </header>

      <!-- ─── Page hero ──────────────────────────────────────────────────── -->
      <div class="container-width relative pb-16 pt-10">
        <span
          class="inline-flex items-center gap-1.5 rounded-full border border-green/30 bg-green/8 px-3 py-1 text-xs font-semibold uppercase tracking-widest text-green"
        >
          <svg width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.8">
            <rect x="3" y="7" width="10" height="8" rx="1.5"/>
            <path d="M5 7V5a3 3 0 0 1 6 0v2"/>
          </svg>
          Web Key Discovery · WKD
        </span>

        <h1 class="mt-5 max-w-3xl text-4xl font-semibold tracking-tight text-text md:text-6xl">
          OpenPGP public key<br class="hidden md:block" /> directory
        </h1>
        <p class="mt-5 max-w-2xl text-base text-muted md:text-lg">
          Any compatible client — Proton Mail, Tuta, Thunderbird, Mailvelope — can automatically fetch
          the OpenPGP public key of a <span class="text-text">@leter.net</span> user from this
          directory. No manual key exchange required.
        </p>
      </div>
    </section>

    <!-- ─── Main content ──────────────────────────────────────────────── -->
    <main class="container-width py-12">

      <!-- Key lookup tool ─────────────────────────────────────────────── -->
      <section class="mb-12">
        <p class="eyebrow">Key lookup</p>
        <h2 class="section-title mt-2">Find a user's public key</h2>
        <p class="mt-3 text-sm text-muted">
          Enter a <code class="rounded border border-white/10 bg-white/5 px-1.5 py-0.5 font-mono text-xs text-green">@leter.net</code>
          email address to check whether their OpenPGP public key is published on this domain.
        </p>

        <div
          class="relative mt-5 overflow-hidden rounded-xl border border-green/25 bg-panel/80 p-6"
          style="background: radial-gradient(ellipse at 0% 0%, rgba(74,222,128,0.055), transparent 55%), #111;"
        >
          <label for="email-input" class="block text-xs font-medium text-muted">Email address</label>
          <div class="mt-2 flex items-center gap-3">
            <input
              id="email-input"
              type="email"
              placeholder="user@leter.net"
              autocomplete="off"
              spellcheck="false"
              class="w-full rounded-lg border border-white/15 bg-white/4 px-3.5 py-2.5 text-sm text-text placeholder-muted/50 outline-none transition-colors focus:border-green/50"
            />
          </div>

          <!-- Result: key found -->
          <div id="key-found" class="mt-4 hidden rounded-lg border border-green/20 bg-green/5 p-4">
            <div class="flex items-center gap-2">
              <svg class="text-green" width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M6 10l3 3 5-6" stroke-linecap="round" stroke-linejoin="round"/>
                <circle cx="10" cy="10" r="8"/>
              </svg>
              <p class="text-sm font-semibold text-green">Public key published</p>
            </div>
            <p class="mt-2 text-xs text-muted">
              WKD hash: <code id="hash-value" class="font-mono text-green"></code>
            </p>
            <p class="mt-1 break-all text-xs text-muted">
              Key URL: <a id="key-url" href="#" class="font-mono text-green/80 underline underline-offset-2" target="_blank" rel="noreferrer"></a>
            </p>
            <p class="mt-3 text-xs text-muted">
              Email clients that support WKD will fetch this key automatically when composing an encrypted message.
            </p>
            <a
              id="download-btn"
              href="#"
              download=""
              class="mt-3 inline-flex items-center gap-2 rounded-lg bg-green px-4 py-2 text-sm font-semibold text-black transition-opacity hover:opacity-90"
            >
              <svg width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10 3v10M5 10l5 5 5-5" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M3 17h14" stroke-linecap="round"/>
              </svg>
              Download public key
            </a>
          </div>

          <!-- Result: key NOT found -->
          <div id="key-not-found" class="mt-4 hidden rounded-lg border border-white/10 bg-white/4 p-4">
            <div class="flex items-center gap-2">
              <svg class="text-muted" width="16" height="16" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
                <circle cx="10" cy="10" r="8"/>
                <path d="M7 7l6 6M13 7l-6 6" stroke-linecap="round"/>
              </svg>
              <p class="text-sm font-medium text-text">No public key published</p>
            </div>
            <p class="mt-2 text-xs text-muted">
              WKD hash: <code id="hash-value-nf" class="font-mono text-muted"></code>
            </p>
            <p class="mt-2 text-sm text-muted">
              This user has not published their OpenPGP public key on this domain yet.
              If you need to send encrypted communication, contact the user and request their key.
            </p>
          </div>

          <!-- Wrong domain notice -->
          <div id="domain-notice" class="mt-4 hidden items-start gap-2 rounded-lg border border-white/10 bg-white/4 p-3 text-xs text-muted">
            <svg class="mt-0.5 shrink-0" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
              <path d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16Z M10 6v4 M10 14h.01" stroke-linecap="round"/>
            </svg>
            <span>This directory serves keys for <code class="font-mono">@leter.net</code> addresses only.</span>
          </div>
        </div>
      </section>

      <!-- Interoperability ────────────────────────────────────────────── -->
      <section class="mb-12">
        <p class="eyebrow">Interoperability</p>
        <h2 class="section-title mt-2">WKD-compatible clients</h2>
        <ul class="mt-4 grid grid-cols-2 gap-2 md:grid-cols-3">
          {[
            "Proton Mail",
            "Tuta (Tutanota)",
            "Thunderbird",
            "Mailvelope",
            "Evolution",
            "KMail",
            "GPG Suite (macOS)",
            "Gpg4win (Windows)",
            "Sequoia PGP",
            "Delta Chat",
            "Mutt / NeoMutt",
            "Any WKD client",
          ].map((name) => (
            <li class="flex items-center gap-2 rounded-lg border border-white/10 bg-panel/80 px-3 py-2.5 text-sm text-muted">
              <span class="h-1.5 w-1.5 shrink-0 rounded-full bg-green"></span>
              {name}
            </li>
          ))}
        </ul>
      </section>

      <!-- End-to-end encryption guidance ──────────────────────────────── -->
      <section class="mb-12">
        <p class="eyebrow">For External Senders</p>
        <h2 class="section-title mt-2">Sending encrypted mail to leter.net</h2>

        <div class="card mt-5 space-y-4 text-sm text-muted">
          <p>
            <span class="font-semibold text-text">If a key is published:</span> Your email client
            will automatically discover it via WKD and encrypt your message (assuming you use a supported client). 
            No action is needed on your part — just compose and send.
          </p>
          <p>
            <span class="font-semibold text-text">If no key is published:</span> End-to-end encryption is always preferable, especially if you are a bank,
            legal counsel, or handling sensitive communication. Contact the
            recipient directly and request that they provide their key manually.
          </p>
          <p>
            End-to-end encryption ensures that <span class="text-text">only the intended recipient</span> can read the message. No
            server, provider, or administrator — including leter.net — can intercept the content.
          </p>
        </div>
      </section>

      <!-- How keys are managed ────────────────────────────────────────── -->
      <section class="mb-12">
        <p class="eyebrow">For Leter.net Users</p>
        <h2 class="section-title mt-2">Admin-verified key publication</h2>

        <div class="card mt-5 space-y-4 text-sm text-muted">
          <p>
            To maintain the highest level of trust, public keys published to the <code class="text-xs text-text">leter.net</code> 
            WKD directory are <span class="font-semibold text-green">strictly administrator-verified</span>. 
          </p>
          <p>
            While you can upload your OpenPGP public key to public keyservers like <code class="text-xs text-text">keys.openpgp.org</code>, 
            <code class="text-xs text-text">keyserver.ubuntu.com</code>, or Mailvelope's key server, <strong>those uploads are completely 
            independent of this directory</strong>. Third-party keyservers only verify email ownership; they do not carry the organizational 
            endorsement of Lewsion or the leter.net domain.
          </p>
          <p>
            By restricting the official WKD endpoint to admin-verified keys, we establish a definitive, high-confidence source of truth for 
            journalists and external senders. When a sender's client fetches a key from this specific domain, they are guaranteed that the 
            key belongs to a verified member of the leter.net initiative.
          </p>
          <p>
            <span class="font-semibold text-text">How to publish:</span> There is currently no automated self-service key submission. 
            If you need your key published here, please provide your exported binary OpenPGP public key directly to the domain administrators. 
            We plan to expand this to an automated internal system in the future.
          </p>
        </div>
      </section>

      <!-- What is OpenPGP / WKD ─────────────────────────────────────── -->
      <section class="mb-12">
        <p class="eyebrow">Background</p>
        <h2 class="section-title mt-2">What is OpenPGP and WKD?</h2>

        <div class="card mt-5 space-y-4 text-sm text-muted">
          <p>
            <span class="font-semibold text-text">OpenPGP</span> (RFC 4880) is the open standard for
            end-to-end encrypted email. A sender encrypts with the recipient's <em>public key</em>;
            only the recipient — holding the matching <em>private key</em> — can decrypt it.
          </p>
          <p>
            <span class="font-semibold text-text">Web Key Directory (WKD)</span> solves the historic problem of key distribution. 
            Instead of relying on noisy, decentralized keyservers, WKD anchors key discovery to domain ownership. 
            A client simply asks the domain directly over HTTPS: <em>"Do you have a public key for user@leter.net?"</em> 
            This is deterministic, secure, and built into every major secure email client.
          </p>
        </div>
      </section>

      <!-- Technical reference ─────────────────────────────────────────── -->
      <section class="mb-6">
        <p class="eyebrow">Technical Reference</p>
        <h2 class="section-title mt-2">Hash generator & path structure</h2>
        <div class="card mt-5 space-y-4 text-sm text-muted">
          <p>
            WKD identifies keys by a z-base-32 encoded SHA-1 hash of the lowercased local part of the email address. 
            Leter uses the <span class="font-semibold text-text">direct method</span>. Keys are served at:
          </p>
          <pre class="overflow-x-auto rounded-lg border border-white/10 bg-white/4 px-4 py-3 font-mono text-xs text-green"><code>https://leter.net/.well-known/openpgpkey/hu/&lt;zbase32-sha1-localpart&gt;</code></pre>
          
          <div class="mt-4 border-t border-white/5 pt-4">
            <label for="hash-input" class="block text-xs font-medium text-text">Standalone hash generator</label>
            <input
              id="hash-input"
              type="email"
              placeholder="user@leter.net"
              autocomplete="off"
              spellcheck="false"
              class="mt-2 w-full rounded-lg border border-white/15 bg-black/50 px-3.5 py-2 text-sm text-text placeholder-muted/50 outline-none transition-colors focus:border-green/50"
            />
            <div id="hash-result" class="mt-3 hidden">
              <p class="text-xs text-muted">Hash: <code id="dev-hash" class="font-mono text-green"></code></p>
              <p class="mt-1 break-all text-xs text-muted">Path: <code id="dev-path" class="font-mono text-green/80"></code></p>
            </div>
          </div>
        </div>
      </section>

    </main>

    <SiteFooter />

    <!-- ─── Client-side logic ─────────────────────────────────────────── -->
    <script>
      const ZBASE32 = 'ybndrfg8ejkmcpqxot1uwisza345h769';
      const DOMAIN  = 'leter.net';
      const BASE    = 'https://leter.net/.well-known/openpgpkey/hu/';

      function zbase32Encode(bytes: Uint8Array): string {
        let bits = 0, value = 0, out = '';
        for (let i = 0; i < bytes.length; i++) {
          value = (value << 8) | bytes[i];
          bits += 8;
          while (bits >= 5) {
            out += ZBASE32[(value >>> (bits - 5)) & 31];
            bits -= 5;
          }
        }
        if (bits > 0) out += ZBASE32[(value << (5 - bits)) & 31];
        return out;
      }

      async function wkdHash(localPart: string): Promise<string> {
        const enc = new TextEncoder().encode(localPart.toLowerCase());
        const buf = await crypto.subtle.digest('SHA-1', enc);
        return zbase32Encode(new Uint8Array(buf));
      }

      // ─── Key lookup tool ────────────────────────────────────────────
      const emailInput    = document.getElementById('email-input') as HTMLInputElement;
      const keyFound      = document.getElementById('key-found')!;
      const keyNotFound   = document.getElementById('key-not-found')!;
      const hashValEl     = document.getElementById('hash-value')!;
      const hashValNfEl   = document.getElementById('hash-value-nf')!;
      const keyUrlEl      = document.getElementById('key-url') as HTMLAnchorElement;
      const downloadBtn   = document.getElementById('download-btn') as HTMLAnchorElement;
      const domainNotice  = document.getElementById('domain-notice')!;

      let lookupTimer: ReturnType<typeof setTimeout>;

      emailInput.addEventListener('input', () => {
        clearTimeout(lookupTimer);
        lookupTimer = setTimeout(() => lookupKey(emailInput.value.trim()), 300);
      });

      async function lookupKey(email: string) {
        resetLookup();
        const at = email.indexOf('@');
        if (at < 1) return;

        const local  = email.slice(0, at);
        const domain = email.slice(at + 1).toLowerCase();

        if (domain !== DOMAIN) {
          if (email.includes('@')) {
            domainNotice.classList.remove('hidden');
            domainNotice.classList.add('flex');
          }
          return;
        }

        const hash = await wkdHash(local);
        const url  = BASE + hash;

        try {
          const res = await fetch(url, { method: 'HEAD' });
          if (res.ok) {
            hashValEl.textContent   = hash;
            keyUrlEl.textContent    = url;
            keyUrlEl.href           = url;
            downloadBtn.href        = url;
            downloadBtn.download    = hash + '.pgp';
            keyFound.classList.remove('hidden');
          } else {
            hashValNfEl.textContent = hash;
            keyNotFound.classList.remove('hidden');
          }
        } catch {
          hashValNfEl.textContent = hash;
          keyNotFound.classList.remove('hidden');
        }
      }

      function resetLookup() {
        keyFound.classList.add('hidden');
        keyNotFound.classList.add('hidden');
        domainNotice.classList.add('hidden');
        domainNotice.classList.remove('flex');
      }

      // ─── Dev hash generator ─────────────────────────────────────────
      const hashInput  = document.getElementById('hash-input') as HTMLInputElement;
      const hashResult = document.getElementById('hash-result')!;
      const devHash    = document.getElementById('dev-hash')!;
      const devPath    = document.getElementById('dev-path')!;

      let devTimer: ReturnType<typeof setTimeout>;

      if (hashInput) {
        hashInput.addEventListener('input', () => {
          clearTimeout(devTimer);
          devTimer = setTimeout(() => computeDevHash(hashInput.value.trim()), 200);
        });
      }

      async function computeDevHash(email: string) {
        hashResult.classList.add('hidden');
        const at = email.indexOf('@');
        if (at < 1) return;

        const local = email.slice(0, at);
        const hash  = await wkdHash(local);

        devHash.textContent = hash;
        devPath.textContent = '/.well-known/openpgpkey/hu/' + hash;
        hashResult.classList.remove('hidden');
      }
    </script>
  </body>
</html>
